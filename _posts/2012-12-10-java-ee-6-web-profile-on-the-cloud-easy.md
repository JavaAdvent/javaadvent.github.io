---
id: 79
title: Java EE 6 Web Profile. On the cloud. Easy.
date: 2012-12-10T11:04:00+00:00
author: gpanther
layout: post
guid: http://www.javaadvent.com/2012/12/java-ee-6-web-profile-on-the-cloud-easy/
permalink: /2012/12/java-ee-6-web-profile-on-the-cloud-easy.html
blogger_blog:
  - www.javaadvent.com
blogger_author:
  - Christophe Thiebaud
blogger_permalink:
  - /2012/12/java-ee-6-web-profile-on-cloud-easy.html
blogger_internal:
  - /feeds/2481158163384033132/posts/default/2114480510195213518
geo_latitude:
  - 47.461034
geo_longitude:
  - 6.859218
geo_public:
  - 1
geo_address:
  - Seloncourt, France
dsq_thread_id:
  - 4962579201
categories:
  - 2012
  - Cloud
  - java
  - Java EE6
  - NetWeaver
  - SAP
---
<a href="https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcSUHjcLQJdVyXSfdSRSbdJOcZhIoqjUdbqS-E0qONDO8kb3GmSMYw" style="clear: left; float: left; margin-right: 1em;"><img border="0" height="68" src="https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcSUHjcLQJdVyXSfdSRSbdJOcZhIoqjUdbqS-E0qONDO8kb3GmSMYw" width="55" /></a><a href="http://1.bp.blogspot.com/-2UBlukErqLI/UMSKGyo7XeI/AAAAAAAAAAQ/spqIawcwLSc/s1600/java-evil-edition.png" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="200" src="http://1.bp.blogspot.com/-2UBlukErqLI/UMSKGyo7XeI/AAAAAAAAAAQ/spqIawcwLSc/s200/java-evil-edition.png" width="124" /></a><br /><div><strong>Java SE is ok.</strong></div><div style="float: right;"><strong>Java EE is evil.</strong></div><br />That's what I always used to think. Well, not anymore, now. Let me share my experience.<br /><br />Some weeks ago, I started thinking about porting a legacy spring+hibernate+tomcat application to a new platform : <a href="http://scn.sap.com/community/developer-center/cloud-platform">SAP NetWeaver Cloud</a>. I known what you geeks out there are thinking : this post is getting worse. It starts with Java EE, not exactly a geeky thing, and now enters <a href="http://www.sap.com/">SAP</a>, not exactly a geek company... Please, give me another ten minutes !<br /><br />The configuration of the spring layer of my legacy application was xml-based (it was written before annotations came in the game). I was dreaded by the prospect of diving into - my own - xml horror again. <br /><br />Then came this tweet : <br /><blockquote>Welcome @<a href="https://twitter.com/sap">sap</a> to <a href="https://twitter.com/search/%23JavaEE6">#JavaEE6</a> party, NetWeaver Cloud is now Java EE 6 Web Profile Certified: <a href="http://t.co/KPaqdE0m" title="http://bit.ly/Wf8VNS">bit.ly/Wf8VNS</a><br />— GlassFish (@glassfish) <a data-datetime="2012-11-16T18:02:17+00:00" href="https://twitter.com/glassfish/status/269500651917160450">November 16, 2012</a></blockquote> and, some days later, <a href="https://help.netweaver.ondemand.com/default.htm?add_persistence_ejb.html#concept_8D93CDC977F049309942563E819F9A08_77">this documentation</a>. And I tried it out. And it worked. And I changed my mind about Java EE. There is a blog post by 'Bill the Plumber' that <a href="http://bill.burkecentral.com/2012/03/13/java-ee-wins-over-spring/">precisely describe what are my thoughts</a> after this experience.<br /><br />So much with the bla bla bla. Let's start coding! If you are in a hurry, clone the complete application from <a href="https://github.com/cthiebaud/adventscloud">https://github.com/cthiebaud/adventscloud</a><br /><br />Before cutting and pasting like mad, let's describe briefly what the code below is about. We will construct and deploy in the cloud (free) a tiny web application that:<br />1. logs in the user (sorry, you'll need a <a href="http://scn.sap.com/docs/DOC-18437">SAP Community Network</a> account, do not worry it's free),<br />2. upon login, say 'hello' to the rest of the world on behalf of the user, <br />3. upon successive logins, instead of saying 'hello' again and again, merely store in a database how many 'hellos' were said, and <br />4. that's it.<br /><br />To achieve that, we'll need one java interface, three java classes, one java server page, and a final touch of persistence.xml (for the database configuration) and web.xml (for security constraint wizardry).<br /><br /><i>For the sake of brevity, packages, imports, getters and setters are omitted from the code below. But, as just said, the <a href="https://github.com/cthiebaud/adventscloud">complete source is available @ github</a></i><br /><br />Write one Hello.java POJO (complete class <a href="https://github.com/cthiebaud/adventscloud/blob/d326c2d95f3676250cca66ac2bc480353390c60a/src/main/java/net/aequologica/adventscloud/Hello.java" target="_blank">here</a>):<br /><pre style="border: solid thin gray;"><code>public class Hello {<br />  <br />  private Long      id;<br />  private String    username;<br />  private Integer   counter;<br />  private Timestamp when;<br />  // ... getters and setters ...<br />}</code></pre>Fairly obvious : for each <code>username</code>, this POJO will store in a <code>counter</code> how many time the user hit the index.jsp of our app, and <code>when</code> was the last time.<br /><br />Annotate this Hello.java POJO with JPA annotations (complete class <a href="https://github.com/cthiebaud/adventscloud/blob/78060ded939419d8d8981c5060dff58d23e336c7/src/main/java/net/aequologica/adventscloud/Hello.java" target="_blank">here</a>):<br /><pre style="border: solid thin gray;"><code>@Entity<br />@Table(name="T_HELLO")<br />@NamedQueries( {<br />  @NamedQuery(name = "allHellos", query = "select h from Hello h"),<br />  @NamedQuery(name = "helloFromUsername", query = "select h from Hello h where h.username = :username")<br />})<br />public class Hello {<br />  <br />  @Id<br />  @GeneratedValue<br />  private Long      id;<br />  @Column(name="A_USER", unique=true, nullable=false)<br />  private String    username;<br />  @Column(name="A_COUNTER", nullable=false)<br />  private Integer   counter;<br />  @Version<br />  @Column(name="A_TIMESTAMP", nullable=false)<br />  private Timestamp when;<br /><br />  public Hello() {<br />    this.counter = 1;<br />  }<br />  // ... getters and setters ...<br />}</code></pre>Write one HelloDao.java interface that accesses the POJO (complete interface <a href="https://github.com/cthiebaud/adventscloud/blob/4d6c98f252b0b7cb5f0a94d525d3ea7b222cb283/src/main/java/net/aequologica/adventscloud/HelloDao.java" target="_blank">here</a>)<br /><pre style="border: solid thin gray;"><code>@Local<br />public interface HelloDao {<br /> <br />  List&lt;hello&gt; getAll();<br />  Hello fromUsername(String username);<br />  Hello save(Hello hello);<br />}<br /></code></pre>Write one HelloBean.java, annotated with EJB annotations, that implements the HelloDao interface (complete class <a href="https://github.com/cthiebaud/adventscloud/blob/78060ded939419d8d8981c5060dff58d23e336c7/src/main/java/net/aequologica/adventscloud/HelloBean.java" target="_blank">here</a>):<br /><pre style="border: solid thin gray;"><code>@Stateless<br />public class HelloBean implements HelloDao {<br /><br />  <strong>@PersistenceContext<br />  private EntityManager em;</strong><br /><br />  @Override<br />  public List&lt;hello&gt; getAll() {<br />    @SuppressWarnings("unchecked")<br />    List&lt;hello&gt; hellos = (List&lt;hello&gt;)em.createNamedQuery("allHellos").getResultList();<br />    <br />    Collections.sort(hellos, new Comparator&lt;hello&gt;() {<br />      @Override<br />      public int compare(Hello o1, Hello o2) {<br />        return o2.getWhen().compareTo(o1.getWhen()); // latest first<br />      }<br />    });<br />    <br />    return hellos;<br />  }<br /><br />  @Override<br />  public Hello fromUsername(String username) {<br />    Query query = em.createNamedQuery("helloFromUsername");<br />    query.setParameter("username", username);<br />    Hello hello = null;<br />    try {<br />      hello = (Hello)query.getSingleResult();<br />    } catch (NoResultException ignored) {<br />    }<br />    <br />    return hello;<br />  }<br /><br />  @TransactionAttribute<br />  @Override<br />  public Hello save(Hello hello) {<br />    hello = em.merge(hello);<br />    return hello;<br />  }<br />}</code></pre>Write one HelloFilter.java Java Servlet 3 Filter, that 1. bumps the counter upon login, and 2. exposes the HelloBean instance to the - coming soon - Java Server page (complete class <a href="https://github.com/cthiebaud/adventscloud/blob/06fc6790bf6d3dfe8b40cce9ca3e313bbeb7d773/src/main/java/net/aequologica/adventscloud/HelloFilter.java" target="_blank">here</a>):<br /><pre style="border: solid thin gray;"><code><strong>@WebFilter("/index.jsp")</strong><br />public final class HelloFilter implements Filter {<br /><br />  <strong>@EJB<br />  HelloDao  helloDao;</strong><br /><br />  @Override<br />  public void init(FilterConfig fConfig) throws ServletException {<br />  }<br /><br />  @Override<br />  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {<br />  try {<br />    request.setAttribute("helloDao", helloDao);<br />    <br />    String username = ((HttpServletRequest)request).getRemoteUser();<br />    Hello hello = helloDao.fromUsername(username);<br />    if (hello == null) {<br />      hello = new Hello();<br />      hello.setUsername(username);<br />    } else {<br />      hello.setCounter(hello.getCounter()+1);<br />    }<br />    hello = helloDao.save(hello);<br />    <br />    chain.doFilter(request, response);<br />    <br />  } finally {<br />    request.removeAttribute("helloDao");<br />  }<br />  }<br /><br />  @Override<br />  public void destroy() {<br />  }<br />}</code></pre>NB. in bold above, the magic plumbing done by our Java EE 6 Web Profile container between all these classes : <code>@PersistenceContext EntityManager em;<br />@EJB HelloDao helloDao;<br />@WebFilter("/index.jsp")</code><br />Write one persistence.xml JPA configuration (complete xml <a href="https://github.com/cthiebaud/adventscloud/blob/78060ded939419d8d8981c5060dff58d23e336c7/src/main/resources/META-INF/persistence.xml" target="_blank">here</a>)<br /><pre style="border: solid thin gray;"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />  xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;<br />  &lt;persistence-unit name="adventscloud-persist" transaction-type="JTA"&gt;<br />    &lt;provider&gt;org.eclipse.persistence.jpa.PersistenceProvider&lt;/provider&gt;<br />    <strong>&lt;jta-data-source&gt;jdbc/DefaultDB&lt;/jta-data-source&gt;</strong><br />    <strong>&lt;class&gt;net.aequologica.adventscloud.Hello&lt;/class&gt;</strong><br />    &lt;properties&gt;<br />      &lt;property name="eclipselink.ddl-generation" value="create-or-extend-tables" /&gt;<br />    &lt;/properties&gt;<br />  &lt;/persistence-unit&gt;<br />&lt;/persistence&gt;</code></pre>Write one web.xml to trigger login when user access index.jsp and to inform the web application of the presence of a container managed database (complete xml <a href="https://github.com/cthiebaud/adventscloud/blob/1a1b3e86fdaf776c66fd85b7e09ae0dc8822b6f7/src/main/webapp/WEB-INF/web.xml" target="_blank">here</a>):<br /><pre style="border: solid thin gray;"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;web-app<br />  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />  xmlns="http://java.sun.com/xml/ns/javaee"<br />  xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"<br />  version="3.0"&gt;<br /><br />  &lt;login-config&gt;<br />    &lt;auth-method&gt;FORM&lt;/auth-method&gt;<br />  &lt;/login-config&gt;<br /><br />  &lt;security-constraint&gt;<br />    &lt;web-resource-collection&gt;<br />      &lt;web-resource-name&gt;Protected Area&lt;/web-resource-name&gt;<br />      &lt;url-pattern&gt;/index.jsp&lt;/url-pattern&gt;<br />    &lt;/web-resource-collection&gt;<br />    &lt;auth-constraint&gt;<br />      &lt;role-name&gt;Everyone&lt;/role-name&gt;<br />    &lt;/auth-constraint&gt;<br />  &lt;/security-constraint&gt;<br />  &lt;security-role&gt;<br />    &lt;description&gt;All SAP NetWeaver Cloud users&lt;/description&gt;<br />    &lt;role-name&gt;Everyone&lt;/role-name&gt;<br />  &lt;/security-role&gt;<br />  <br />  &lt;resource-ref&gt;<br />    <strong>&lt;res-ref-name&gt;jdbc/DefaultDB&lt;/res-ref-name&gt;</strong><br />    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;<br />  &lt;/resource-ref&gt;<br />  <br />&lt;/web-app&gt;</code></pre>Again, NB. above in bold the further magic plumbing: <code>&lt;jta-data-source&gt;jdbc/DefaultDB&lt;/jta-data-source&gt;<br />&lt;class&gt;net.aequologica.adventscloud.Hello&lt;/class&gt;<br />&lt;res-ref-name&gt;jdbc/DefaultDB&lt;/res-ref-name&gt;</code><br />Finally, write one index.jsp java server page that displays all 'hellos' (complete page <a href="https://github.com/cthiebaud/adventscloud/blob/78060ded939419d8d8981c5060dff58d23e336c7/src/main/webapp/index.jsp" target="_blank">here</a>):<br /><pre style="border: solid thin gray;"><code>&lt;%@ taglib prefix="c"   uri="http://java.sun.com/jstl/core_rt" %&gt;<br />&lt;%@ taglib prefix="fmt" uri="http://java.sun.com/jstl/fmt_rt" %&gt;<br />&lt;!DOCTYPE html&gt;<br />&lt;html&gt;<br />  &lt;head&gt;<br />    &lt;title&gt;adventscloud&lt;/title&gt;<br />  &lt;/head&gt;<br />  &lt;body&gt;<br />  <br />  &lt;table&gt;<br />    &lt;tbody&gt;<br />      &lt;c:forEach var="hello" items="${requestScope.helloDao.all}" varStatus="status"&gt;<br />        &lt;tr&gt;<br />          &lt;td&gt;&lt;fmt:formatDate type="both" value="${hello.when}" /&gt;&lt;/td&gt;<br />          &lt;td&gt;${hello.counter}&lt;/td&gt;<br />          &lt;td&gt;hello&lt;c:if test = "${hello.counter &gt; 1}"&gt;(s)&lt;/c:if&gt; from&lt;/td&gt;<br />          &lt;td&gt;${hello.username}&lt;/td&gt;<br />        &lt;/tr&gt;<br />      &lt;/c:forEach&gt;<br />    &lt;/tbody&gt;<br />  &lt;/table&gt;  <br /><br />  &lt;/body&gt;<br /><br />&lt;/html&gt;</code></pre>We're nearly done ... two last things: 1. classpath hell, and 2. JPA 2.0 metamodel generation with javac -processor.<br /><br /><strong>1. Classpath hell.</strong> In order to compile all this stuff, you'll need somehow to have the following jars on the classpath :<br /><pre><strong>group             | artifact          | version</strong><br />javax.persistence : <a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22javax.persistence%22%20AND%20a%3A%22persistence-api%22%20AND%20v%3A%221.0.2%22" target="_blank">persistence-api</a>   : &gt;= 1.0 <br />javax.ejb         : <a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22javax.ejb%22%20AND%20a%3A%22ejb-api%22%20AND%20v%3A%223.0%22" target="_blank">ejb-api</a>           : &gt;= 3.0 <br />javax.servlet     : <a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22javax.servlet%22%20AND%20a%3A%22javax.servlet-api%22%20AND%20v%3A%223.0.1%22" target="_blank">javax.servlet-api</a> : &gt;= 3.0 <br />javax.servlet     : <a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22javax.servlet%22%20AND%20a%3A%22jstl%22%20AND%20v%3A%221.2%22" target="_blank">jstl              </a>: &gt;= 1.2</pre>Of course the easiest way is to declare these dependencies in <a href="https://github.com/cthiebaud/adventscloud/blob/78060ded939419d8d8981c5060dff58d23e336c7/pom.xml">a maven project like mine</a>, but if you are maven-averse, I took the time to hyperlink to the jars above to <a href="http://search.maven.org/">maven central</a> to spare you some time chasing the jars.<br /><br /><strong>2. JPA 2.0 metamodel generation with javac -processor.</strong> Finally , the build must be able to <a href="http://stackoverflow.com/questions/3037593/how-to-generate-jpa-2-0-metamodel">generate JPA 2.0 metamodel classes</a>. Here I choose the eclipselink generator, as eventually eclipselink is the JPA implementation used by SAP NetWeaver Cloud. I believe that any JPA 2.0 compliant generator should do the job as well. Here also, maven do help, with the following xml fragment in the &lt;build&gt;&lt;plugins&gt; section of the pom.xml:<br /><pre style="border: solid thin gray;"><code>&lt;plugin&gt;<br />  &lt;groupId&gt;org.bsc.maven&lt;/groupId&gt;<br />  &lt;artifactId&gt;maven-processor-plugin&lt;/artifactId&gt;<br />  &lt;version&gt;2.1.0&lt;/version&gt;<br />  &lt;executions&gt;<br />    &lt;execution&gt;<br />      &lt;id&gt;process&lt;/id&gt;<br />      &lt;goals&gt;<br />         &lt;goal&gt;process&lt;/goal&gt;<br />      &lt;/goals&gt;<br />      &lt;phase&gt;generate-sources&lt;/phase&gt;<br />      &lt;configuration&gt;<br />        &lt;processors&gt;<br />          &lt;processor&gt;org.eclipse.persistence.internal.jpa.modelgen.CanonicalModelProcessor&lt;/processor&gt;<br />        &lt;/processors&gt;<br />      &lt;/configuration&gt;<br />    &lt;/execution&gt;<br />  &lt;/executions&gt;<br />&lt;/plugin&gt;<br /></code></pre>Maven-averse can refer to <a href="http://wiki.eclipse.org/UserGuide/JPA/Using_the_Canonical_Model_Generator_%28ELUG%29">eclipselink documentation about JPA 2.0 matamodel generation</a> for alternative means to generate JPA 2.0 metamodel classes.<br /><br />At this point, we have a adventscloud.war file that should run verbatim on <a href="http://www.oracle.com/technetwork/java/javaee/overview/compatibility-jsp-136984.html">any Java EE 6 Web Profile compliant container</a>.<br /><br />Among them is SAP NetWeaver Cloud. You can have a look at the application running at my <a href="https://abendrotp1630844092trial.nwtrial.ondemand.com/abendrot-web/socialhello.jsp" target="_blank">lifelong-free trial instance of SAP NetWeaver Cloud</a>. It is a bit richer than the code shown in this blog post, with a spark of<a href="http://twitter.github.com/bootstrap/" target="_blank"> twitter bootstrap</a> bells and whistles. Follow the github ribbon in the app if you are interested by sparks.<br /><br />If you'd like to get <strong>your</strong> lifelong-free trial instance of SAP NetWeaver Cloud, follow the initial steps described <a href="http://cthiebaud.github.com/abendrot/" target="_blank">here</a>.<br /><br /><div style="clear: both; text-align: center;"><a href="http://cthiebaud.github.com/abendrot/icons/7504885-stressed-young-black-woman--sitting-at-a-table-among-books-and-laptop-on-a-white-background.jpg" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="133" src="http://cthiebaud.github.com/abendrot/icons/7504885-stressed-young-black-woman--sitting-at-a-table-among-books-and-laptop-on-a-white-background.jpg" width="200" /></a></div>I hope you enjoyed reading this post as much as I enjoyed writing it. <br /><br />Salut à tous!<br /><br />Christophe<br /><br /><em>Meta: this post is part of the <a href="http://javaadvent.com/">Java Advent Calendar</a> and is licensed under the <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons 3.0 Attribution</a> license. If you like it, please spread the word by sharing, tweeting, FB, G+ and so on! Want to write for the blog? We are looking for contributors to fill all 24 slot and would love to have your contribution! <a href="mailto:dify.ltd@gmail.com">Contact Attila Balazs</a> to contribute!</em><br /><br /><em><br />[0] <a href="http://bill.burkecentral.com/2012/03/13/java-ee-wins-over-spring/">Java EE wins over spring</a><br />[1] <a href="http://www.oracle.com/technetwork/java/javaee/overview/compatibility-jsp-136984.html">Official Java EE compatibility page</a><br />[2] <a href="http://scn.sap.com/community/developer-center/cloud-platform/blog/2012/11/15/sap-netweaver-cloud-is-java-ee-6-web-profile-compatible">'SAP Netweaver Cloud is Java EE 6 Web Profile Compatible' announcement on SAP Community Network</a><br /></em>