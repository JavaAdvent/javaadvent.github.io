---
id: 49
title: 'Performance tuning &#8211; measure don&#8217;t guess'
date: 2013-12-11T09:00:00+00:00
author: iNikem
layout: post
guid: http://www.javaadvent.com/2013/12/performance-tuning-measure-dont-guess/
permalink: /2013/12/performance-tuning-measure-dont-guess.html
blogger_blog:
  - www.javaadvent.com
blogger_author:
  - Nikita Salnikov-Tarnovski
blogger_permalink:
  - /2013/12/performance-tuning-measure-dont-guess.html
blogger_internal:
  - /feeds/2481158163384033132/posts/default/6525816012037471456
categories:
  - 2013
  - High performance
  - performance testing
  - performance tuning
---
<div dir="ltr" style="text-align: left;">In my <a href="http://plumbr.eu/">performance tuning career</a> I have given the advice to measure and not guess more often than I can recall. And in many cases the target of this advice has given up after looking at the monolithic 500,000 LOC legacy application they are working. <br /><br/>In the post we are about to share some simple tools and concepts how to setup the initial measurement, so you can have the baseline to start with more fine-grained performance tuning.<br /><h1>Setting the goal</h1>Pretty much any non-trivial application can be optimized forever. Both in bad and in good way. Bad examples include tweaking random parts of the applications and then praying for the best. Whatever might be the reason - I have seen tens and tens of developers “being pretty sure that exactly this line of code needs attention” without basing their gut feeling to any measurements.<br /><br/>The second category is almost as dangerous, as you can spend hundreds of man-years tuning your application “to be ready for the prime time”. The definition for prime time might vary, but are you really sure you are going to accommodate terabytes of media, tens of millions of records in your database and have to serve hundreds of thousands of concurrent users with less than 100ms latency? Unless you are aiming to put Google out of business, you most likely will not. Worse yet, spending so much time preparing for the primetime is a darn good way to assure the prime time never arrives. Instead of spending this time for squeezing out the extra 1ms in latency nobody is likely to notice, maybe the same time should have spent in ironing out this layout bug annoying the end users on Safari instead?<br /><br/>So how to set a meaningful target? For this you need to understand the business you are in. Real-time strategy games and First Person Shooters tend to have different requirements than online shopping carts. As last time I checked, Java was not going strong in the gaming industry, lets expect you are dealing with a typical Java EE application with web based front-end.<br /><br/>In this case, you should start now segmenting your application into different categories, which, <a href="http://www.nngroup.com/articles/website-response-times/">based on the research</a> are similar to the following: <br /><ul><li>0.1 seconds gives the feeling of instantaneous response — that is, the outcome feels like it was caused by the user, not the computer.</li><li>1 second keeps the user's flow of thought seamless. Users can sense a delay, and thus know the computer is generating the outcome, but they still feel in control of the overall experience and that they're moving freely rather than waiting on the computer. This degree of responsiveness is needed for good navigation.</li><li>10 seconds keeps the user's attention. From 1–10 seconds, users definitely feel at the mercy of the computer and wish it was faster, but they can handle it. After 10 seconds, they start thinking about other things, making it harder to get their brains back on track once the computer finally does respond. </li></ul>So you might have functionality such as adding products to the shopping carts or browsing through the recommended items which you need to squeeze into the “instant” bucket to provide the best overall user experience resulting in better conversion rates. Initially I am pretty sure your application is nowhere near this criteria, so feel free to replace the 100ms and 1,000ms threshold with something you actually can achieve, such as 300 and 1,500ms for example.<br /><br/>On the other hand, you most likely have some operations which are expensive enough, such as the products search or user account registration which might fall into the second bucket.<br /><br/>And last, you have the functionality which you can toss into the last bucket, such as generating PDF from the invoice. Note that you also might end up with fourth category - for example if you are generating the bills of delivery for your warehouse, your business might be completely OK if batch processing the daily bills takes 20 minutes.<br /><br/>Pay attention that business persons have a tendency of tossing everything into the “instant” bucket. Now it is your task to explain the effort required and ask “if you had only three operations which are completing under our threshold, what should those be”.<br /><br/>Now you should have your application functionality categorized into different categories, such as the following:  <table border="1"><tbody><tr><td>Requirement</td><td>Category</td></tr><tr><td>Browse products</td><td>instant</td></tr><tr><td>Add product to a shopping cart</td><td>instant</td></tr><tr><td>Search product</td><td>seamless</td></tr><tr><td>Register new account</td><td>attention</td></tr><tr><td>Generate PDF invoice</td><td>attention</td></tr><tr><td>Generate daily  bills of delivery</td><td>slow</td></tr></tbody></table><br /><h1>Understanding the current situation</h1>Your next goal is to understand where you will perform your measurements. For end users, the experience is complete when the page has rendered the result of the operation in their browser, which takes into account the network latency and browser DOM operations for example.<br />As this will be more complex to measure, let us assume your site has been well optimized against the <a href="https://developers.google.com/speed/pagespeed">Google Page Speed</a> or <a href="http://developer.yahoo.com/yslow/">YSlow</a> recommendations and for simplicity’s sake lets focus on elements directly under your control.<br /><br/>On most cases, the last piece of infrastructure still under your control will be your web server, such as the <a href="http://httpd.apache.org/">Apache HTTPD</a> or <a href="http://wiki.nginx.org/">nginx</a>. If you have logging enabled, you will have access to something similar to the following in your nginx access.log: <br /><pre>82.192.41.11 - - [04/Dec/2013:12:16:11 +0200]  "POST /register HTTP/1.1" 301 184 "https://myshop.com/home" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0" 0.428<br />82.192.41.11 - - [04/Dec/2013:12:16:12 +0200]  "POST /searchProduct HTTP/1.1" 200 35 "https://myshop.com/accountCreated" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0" 3.008 <br />82.192.41.11 - - [04/Dec/2013:12:16:12 +0200]  "GET /product HTTP/1.1" 302 0 "https://myshop.com/products/searchProducts" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0" 0.623<br />82.192.41.11 - - [04/Dec/2013:12:16:13 +0200]  "GET /product HTTP/1.1" 200 35 "https://myshop.com/product/123221" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0" 0.828<br />82.192.41.11 - - [04/Dec/2013:12:16:13 +0200]  "GET /product HTTP/1.1" 200 35 "https://myshop.com/product/128759" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0" 1.038<br />82.192.41.11 - - [04/Dec/2013:12:16:13 +0200]  "GET /product HTTP/1.1" 200 35 "https://myshop.com/product/128773" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0" 0.627<br />82.192.41.11 - - [04/Dec/2013:12:16:14 +0200]  "GET /addToShoppingCart HTTP/1.1" 200 35 "https://myshop.com/product/128773" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0" 2.808<br />82.192.41.11 - - [04/Dec/2013:12:16:14 +0200]  "GET /purchase HTTP/1.1" 302 0 "https://myshop.com/addToShoppingCart" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0" 3.204<br />82.192.41.11 - - [04/Dec/2013:12:16:16 +0200]  "GET /viewPDFInvoice HTTP/1.1" 200 11562 "https://myshop.com/purchase" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0" 3.018<br /></pre>Lets investigate now what we have found in the log. The snippet we have extracted contains actions of one user completing a full transaction in our web site. The user has created an account, searched for products, browsed through the results, found a product he has liked, added it to a shopping cart, completed the purchase and generated a PDF of the invoice. Those actions can be detected in the "POST /searchProduct HTTP/1.1" column. Next important part is the last column containing the total request time it took for a particular request to complete. In the case of /searchProduct it took 3.008 seconds to complete the search.<br /><br/>Note that by default <a href="http://wiki.nginx.org/">nginx</a> does not have the request time logging enabled, so you might need to to modify your <code>log_format</code> by adding <code>$request_time</code> to the pattern.<br /><br/>Now, with a little bit of grep/sed/excel magic, you will have something similar to the following at your fingertips:  <table border="1"><tbody><tr><td>Requirement</td><td>Category</td><td>Mean</td><td>90%</td></tr><tr><td>Browse products</td><td>instant</td><td>0.734</td><td>0.902</td></tr><tr><td>Add product to a shopping cart</td><td>instant</td><td>2.422</td><td>3.490</td></tr><tr><td>Search product</td><td>seamless</td><td>2.800</td><td>3.211</td></tr><tr><td>Register new account</td><td>attention</td><td>0.428</td><td>0.480</td></tr><tr><td>Generate PDF invoice</td><td>attention</td><td>3.441</td><td>4.595</td></tr><tr><td>Generate daily  bills of delivery</td><td>slow</td><td>-</td><td>-</td></tr></tbody></table><br /><h1>Picking the target for optimization</h1>From here you will get your list of optimization targets. The suspects are obvious - they fall in the categories where you violate the agreement, in the above case you have problems with three requirements - Browse products, Add product to a shopping cart and Search product all violate your performance requirements.<br /><br/>This article does not focus on actual optimisation tasks, but in order to give food for thought - what should you do next, knowing that adding products to the shopping cart takes way too much time?<br /><br/>Next steps are definitely more application specific than the prior tasks. Also, the tooling to be used can vary - you might now decide to go with APM or monitoring products. But if you do not have the budget or just do not wish to fight with procurement office, a simple solution would include adding logging trail in the component boundaries by using AOP means.<br /><br/>For example, you can add something like the following in your application code to monitor the time spent in the service layer.  <code></code><br /><pre><code>@Aspect<br />@Component<br />public class TimingAspect {<br /><br />  @Around("execution(* com.myshop..*Service+.*(..))")<br />  public Object time(ProceedingJoinPoint joinPoint) throws Throwable {<br />    StopWatch.WatchStatus watch = StopWatch.getInstance().start(joinPoint.getSignature().getName());<br />    final Object result = joinPoint.proceed();<br />    watch.stop();<br />    return result;<br />  }<br />}<br /></code></pre><code></code>Decomposing the request time further gives you the required insight to understand where the bottlenecks are hiding. More often than not you will quickly discover a violating query, faulty cache configuration or poorly decomposed functionality enabling you to net your first quick wins in a matter of days or even hours.<br /><br/>This post is written by <a href="https://twitter.com/iNikem">@iNikem</a> from <a href="http://plumbr.eu/">Plumbr</a> and is part of the <a href="http://www.javaadvent.com/">Java Advent Calendar</a>. The post is licensed under the <a href="http://creativecommons.org/licenses/by/3.0/us/">Creative Commons 3.0 Attribution</a> license. If you like it, please spread the word by sharing, tweeting, FB, G+ and so on!<br /><br /><br /></div>