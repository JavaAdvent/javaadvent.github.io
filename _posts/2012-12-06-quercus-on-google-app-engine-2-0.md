---
id: 83
title: 'Quercus on Google App Engine &#8211; 2.0'
date: 2012-12-06T09:00:00+00:00
author: gpanther
layout: post
guid: http://www.javaadvent.com/2012/12/quercus-on-google-app-engine-2-0/
permalink: /2012/12/quercus-on-google-app-engine-2-0.html
blogger_blog:
  - www.javaadvent.com
blogger_author:
  - Nam Nguyen
blogger_permalink:
  - /2012/12/quercus-on-google-app-engine-20.html
blogger_internal:
  - /feeds/2481158163384033132/posts/default/9135003371506623167
categories:
  - 2012
  - GAE
  - Google App Engine
  - Google Cloud SQL
  - Google Cloud Storage
  - java
  - MySQL
  - Quercus
  - Wordpress
---
<p>It's been a 3.5 years ago to this day since I last wrote about running Quercus on Google App Engine (GAE).  The <a href="http://blog.caucho.com/2009/05/31/quercus-on-google-app-engine/">article</a> detailed a crazy experiment to get a PHP application, Wordpress, running on GAE.  I still remember it being a painful experience because of number of changes I had to make to Wordpress to get it working.  It was all due to the GAE Java environment being so drastically different from what Java developers were used to.  It was heavily sandboxed and had no SQL support.  You couldn't launch new Threads.  You couldn't write to the file system.  But those were the tradeoffs you had to live with if you wanted to deploy your application to the all-wonderful <em>Cloud</em>. </p> <p>Fast-forward to 2012 and GAE has come a long way.  GAE now allows you to spawn new Threads (currently in beta).  You still cannot write to the file system, but for all it's worth there is a new GAE Files API that gives you file-like concepts.  And you can run your very own MySQL instances on Google's infrastructure (albeit Google's customized version of MySQL). </p> <p>What hasn't changed over the years is that you're still expected to hit major roadblocks as you migrate your existing web applications over to GAE.  And you'll have to make heavy modifications to your application to 1) make it work and 2) be performant on GAE. </p> <p>So this is where Quercus comes into the picture.  At Caucho, we spent a lot of time getting Quercus to work seamlessly with GAE.  Our goal was to abstract the GAE details away so that developers don't have to worry about the fact that the application is running on GAE.  Things just work transparently behind the scenes for PHP applications.  For example, </p> <ul><li>PHP file_*() functions work just like they do before (including writing to files!) </li> <li>PHP mysql_*() functions and PDO work just like they do before </li></ul> <a name='more'></a> <p>What this means is that we can run <u>existing</u> PHP applications on GAE without any modifications!  Say hello to "Wordpress on Google App Engine” 2.0!  But first, let's start with some formalities. </p> <h3><u>I. Introduction to Quercus</u></h3> <p>Quercus is Caucho's 100% Java implementation of the PHP language runtime and libraries.  Currently, Quercus supports PHP 5.3 language features and contains a multitude of libraries developed in-house including but not limited to apc, bcmath, curl, date, dom, filter, gettext, json, mail, mbstring, mcrypt, pdf, pdo, postgres, reflection, regexp, spl, zip, and zlib. </p> <p>Quercus can run as a servlet or on the command line.  For our case, we're interested in running it as a servlet: </p> <ol><li><a href="http://www.caucho.com/download">Download Resin Java Application Server</a> and it'll come with Quercus enabled by default and ready to go. </li> <li>Uncompress the archive and start up Resin with: <pre>    ./bin/resin.sh console</pre></li> <li>Then create a <code>webapps/ROOT/test.php</code> file with the following contents: <code><pre><br />&lt;?php<br /><br />  phpinfo();<br /><br />?&gt;<br /></pre></code></li> <li><p>Browse to <a href="http://localhost:8080/test.php">http://localhost:8080/test.php</a> and you should see the following: </p>  <div style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-fxH6Xqm68yk/UMArJDJJP9I/AAAAAAAAABo/uhpxijdibnM/s1600/quercus_phpinfo.png" style="margin-left:1em; margin-right:1em"><img border="0" height="265" width="400" src="http://4.bp.blogspot.com/-fxH6Xqm68yk/UMArJDJJP9I/AAAAAAAAABo/uhpxijdibnM/s400/quercus_phpinfo.png" /></a></div> </li></ol> <p>Congrats!  You have PHP running natively on a Java server. </p> <p><h3><u>II. Running Quercus on Tomcat</u></h3></p> <p>Okay, so you want to use Tomcat instead of Resin?  No worries. </p> <ol><li>Copy lib/resin.jar from the Resin download above to Tomcat's <code>webapps/ROOT/WEB-INF/lib</code> directory. </li> <li><p>Add QuercusServlet to Tomcat's webapps/ROOT/WEB-INF/web.xml file: </p> <code><pre style="overflow: auto;">&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee" version="2.5"&gt;<br />  &lt;servlet&gt;<br />    &lt;servlet-name&gt;Quercus Servlet&lt;/servlet-name&gt;<br />    &lt;servlet-class&gt;com.caucho.quercus.servlet.GoogleQuercusServlet&lt;/servlet-class&gt;<br />    &lt;init-param&gt;<br />      &lt;param-name&gt;ini-file&lt;/param-name&gt;<br />      &lt;param-value&gt;WEB-INF/php.ini&lt;/param-value&gt;<br />    &lt;/init-param&gt;<br />  &lt;/servlet&gt;<br /><br />  &lt;servlet-mapping&gt;<br />    &lt;servlet-name&gt;Quercus Servlet&lt;/servlet-name&gt;<br />    &lt;url-pattern&gt;*.php&lt;/url-pattern&gt;<br />  &lt;/servlet-mapping&gt;<br /><br />  &lt;welcome-file-list&gt;<br />    &lt;welcome-file&gt;index.php&lt;/welcome-file&gt;<br />  &lt;/welcome-file-list&gt;<br />&lt;/web-app&gt;<br /><br /></pre></code></li></ol> <p>Quercus should now be handling all php HTTP requests. </p> <p><h3><u>III. Running Quercus on GAE</u></h3></p> <p>Quercus runs on top of the GAE Java SDK, so we configure it just like any other servlet.  Before continuing, please read and work through Google's <a href="https://developers.google.com/appengine/docs/java/gettingstarted/">Getting Started: Java – Google App Engine</a>. </p> <ol><li>Create a new GAE project by creating the following directories on your local drive: <pre><br />    quercusproject<br />    quercusproject/src<br />    quercusproject/war<br />    quercusproject/war/WEB-INF<br />    quercusproject/war/WEB-INF/lib<br /></pre></li> <li>Copy lib/resin.jar from the Resin download above to quercusproject/war/WEB-INF/lib.  Note: I've created a special pre-release Quercus snapshot just this article.  Please download it <a href="https://github.com/diablonhn/quercus_on_gae_2/blob/master/quercus_2012_12_06.tar.gz?raw=true">here on GitHub</a> and use the included jars instead.  The snapshot exposes functionality unique to GAE that we originally had hidden. </li> <li>Create a quercusproject/war/WEB-INF/web.xml file for GoogleQuercusServlet: <code><pre style="overflow: auto;">&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee" version="2.5"&gt;<br />  &lt;servlet&gt;<br />    &lt;servlet-name&gt;Quercus Servlet&lt;/servlet-name&gt;<br />    &lt;servlet-class&gt;com.caucho.quercus.servlet.GoogleQuercusServlet&lt;/servlet-class&gt;<br /><br />    &lt;init-param&gt;<br />      &lt;param-name&gt;ini-file&lt;/param-name&gt;<br />      &lt;param-value&gt;WEB-INF/php.ini&lt;/param-value&gt;<br />    &lt;/init-param&gt;<br />  &lt;/servlet&gt;<br /><br />  &lt;servlet-mapping&gt;<br />    &lt;servlet-name&gt;Quercus Servlet&lt;/servlet-name&gt;<br />    &lt;url-pattern&gt;*.php&lt;/url-pattern&gt;<br />  &lt;/servlet-mapping&gt;<br /><br />  &lt;welcome-file-list&gt;<br />    &lt;welcome-file&gt;index.php&lt;/welcome-file&gt;<br />  &lt;/welcome-file-list&gt;<br />&lt;/web-app&gt;<br /></pre></code></li> <li><p>Create a quercusproject/war/WEB-INF/appengine-web.xml file: </p> <code><pre style="overflow: auto;">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br />&lt;appengine-web-app xmlns="http://appengine.google.com/ns/1.0"&gt;<br />  &lt;application&gt;your_app_id_here&lt;/application&gt;<br />  &lt;version&gt;1&lt;/version&gt;<br /><br />  &lt;threadsafe&gt;true&lt;/threadsafe&gt;<br /><br />  &lt;static-files&gt;<br />    &lt;exclude path="/**.php" /&gt;<br />  &lt;/static-files&gt;<br />&lt;/appengine-web-app&gt;<br /></pre></code> <p>Note: remember to change “your_app_id_here” to your actual appspot application ID when deploying to GAE. </p></li> <li>Create a <code>quercusproject/war/test.php</code> file: <pre><code>&lt;?php<br /><br />  phpinfo();<br /><br />?&gt;<br /></code></pre></li> <li>Start up the GAE development server with Eclipse or with ant: <code><pre>    ant runserver</pre></code></li> <li>Browse to <a href="http://localhost:8080/test.php">http://localhost:8080/test.php</a>and you should reach the PHP info page titled “Quercus”. </li></ol> <p>At this point, the test project should be complete and deployable to GAE.<br /></p> <p><h3><u>IV. Writing to files on GAE</u></h3></p> <p>GAE does not allow applications to write to the local file system.  However, Google recently added a files-like API (<a href="https://developers.google.com/appengine/docs/java/javadoc/index">com.google.appengine.api.files</a>) that applications can use to write streams to GAE DataStore or Google Cloud Storage.  Quercus leverages this API to grant write capability to PHP file functions.  In addition, Quercus goes a step further and merges the local and network file systems together to create a unified view.  For example, consider the following script: </p> <code><pre style="overflow: auto;">&lt;pre&gt;<br />&lt;?php<br /><br />  $filename = 'test.txt';<br />  var_dump(file_get_contents($filename));<br /><br />  file_put_contents($filename, 'modified at time ' . date('Y-m-d H:i:s O'));<br />  var_dump(file_get_contents($filename));<br /><br />?&gt;<br /></pre></code> <p>Suppose the file <code>test.txt</code> exists on the local file system.  The first <code>file_get_contents()</code> call retrieves it.  Then we try to overwrite that file.  But since GAE does not allow writes to the local file system, Quercus writes to Google Cloud Storage instead.  The next <code>file_get_contents()</code> call retrieves the newly-written file with the new data, not the old local file.  And if the network file is cached in memcache, Quercus will serve that instead.  <em>This is all done transparently behind-the-scenes and at no point is the application aware that it's not reading/writing to the local file system.</em></p> <p><h4><u>A. Setting up Quercus to use Google Cloud Storage</u></h4></p> <p>Google Cloud Storage is structured around uniquely-named buckets, which are very similar to mounted disk drives.  As with regular drives, buckets can hold a hierarchical list of files and directories.  To start things off, we need to enable Google Cloud Storage, create a bucket, and grant our application access to Google Cloud Storage. </p> <ol><li><p><a href="https://developers.google.com/storage/docs/signup">Activate Google Cloud Storage</a> and enable billing. </p><p>Google Cloud Storage is free for the first 5GB of storage. </p></li> <li><p>Go to your <a href="https://code.google.com/apis/console/#project:880248184729">Google API Console</a> => Google Cloud Storage => Google Cloud Storage Manager. Create a new bucket named “quercusbucket0”. </p><p>If you cannot create a new bucket, then it's very likely your billing is not enabled or is still pending. </p></li> <li><p>Go to your <a href="https://appengine.google.com/">Google App Engine Overview</a> => select or create your application => Application Settings.  Make a note of the application's “Service Account Name”.  Then go to <a href="https://code.google.com/apis/console/#project:880248184729">Google API Console</a> => Team.  Create a new teammate with the “Service Account Name”. </p> <p>Note: if you had just created a new application, remember to update your <code>quercusproject/war/WEB-INF/appengine-web.xml</code> with the actual application ID. </p></li> <li><p>Your GAE application should now has access to most of your Google APIs including Google Cloud Storage (but not Google Cloud SQL unfortunately).  We now need to give Quercus the name of the bucket we just created.  We do so by setting a servlet init-param in the <code>web.xml</code> file: </p> <code><pre style="overflow: auto;"><br />&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee" version="2.5"&gt;<br />  &lt;servlet&gt;<br />    &lt;servlet-name&gt;Quercus Servlet&lt;/servlet-name&gt;<br />    &lt;servlet-class&gt;com.caucho.quercus.servlet.GoogleQuercusServlet&lt;/servlet-class&gt;<br /><br />    &lt;init-param&gt;<br />      &lt;param-name&gt;ini-file&lt;/param-name&gt;<br />      &lt;param-value&gt;WEB-INF/php.ini&lt;/param-value&gt;<br />    &lt;/init-param&gt;<br /><br />    <strong>&lt;init-param&gt;</strong><br />      <strong>&lt;param-name&gt;cloud-storage-bucket&lt;/param-name&gt;</strong><br />      <strong>&lt;param-value&gt;quercusbucket0&lt;/param-value&gt;</strong><br />    <strong>&lt;/init-param&gt;</strong><br />  &lt;/servlet&gt;<br /><br />  &lt;servlet-mapping&gt;<br />    &lt;servlet-name&gt;Quercus Servlet&lt;/servlet-name&gt;<br />    &lt;url-pattern&gt;*.php&lt;/url-pattern&gt;<br />  &lt;/servlet-mapping&gt;<br /><br />  &lt;welcome-file-list&gt;<br />    &lt;welcome-file&gt;index.php&lt;/welcome-file&gt;<br />  &lt;/welcome-file-list&gt;<br />&lt;/web-app&gt;<br /></pre></code> <p>Note: the bucket name can also be set in a php.ini file, but that capability is broken at the moment. </p> <p>Note: you do not need to enable Google Cloud Storage and billing in order to test on the development server, but you do need to set <code>&lt;cloud-storage-bucket&gt; </code>. </p></li> <li>Create a <code>quercusproject/war/vfs.php</code> file with the following:  <code><pre style="overflow: auto;"><br />&lt;pre&gt;<br />&lt;?php<br /><br />  $filename = 'test.txt';<br />  var_dump(file_get_contents($filename));<br /><br />  file_put_contents($filename, 'modified at time ' . date('Y-m-d H:i:s O'));<br />  var_dump(file_get_contents($filename));<br /><br />?&gt;<br /><br /></pre></code></li> <li>Launch the development server or deploy to GAE.  Browse to the vfs.php page.  Refresh a few times.  You should see something like the following: <pre>string(42) "modified at time 2012-12-05 22:04:21 +0000"<br />string(42) "modified at time 2012-12-05 22:25:28 +0000”<br /></pre></li></ol> <p><h3><u>V. Executing SQL queries on GAE</u></h3></p> <p>For the longest time, Google's distributed key-value store was GAE's only persistent store option.  However not all use cases can be boxed into key-values, so Google Cloud SQL was a welcome addition to GAE.  It does come at a price because Cloud SQL has no free quota and you're forced to pay from the start. </p> <p><em>Update: as of 2012-11-08, Google is offering a free 6-month trial for a tiny D0 instance.</em></p> <p>As with the PHP file functions, Quercus transparently maps PHP mysql and PDO functions to Cloud SQL.  The only caveat is that the host url must begin with "jdbc:google:rdbms://" instead of localhost or a remote IP or domain name.  Quercus will recognize the following and connect to Cloud SQL appropriately: </p> <code><pre><br />&lt;?php<br /><br />  $db = mysql_connect('jdbc:google:rdbms://foo:bar');<br /><br />?&gt;<br /></pre></code> <p><h4><u>A. Setting up the Development Server to use local MySQL</u></h4></p> <p>To do testing, we need to set up the development server to use the local MySQL instance. </p> <ol><li>Download the MySQL JDBC driver at <a href="http://dev.mysql.com/downloads/connector/j/">http://dev.mysql.com/downloads/connector/j/</a>.  Uncompress mysql-connector-java-5.1.22.tar.gz and place mysql-connector-java-5.1.22-bin.jar into your <code>&lt;appengine-sdk&gt;/lib/impl</code> directory. </li> <li><p>Follow the instructions at Google's <a href="https://developers.google.com/appengine/docs/java/cloud-sql/developers-guide#using_the_java_development_server">Using a Local MySQL Instance During Development</a>. </p> <p>If you're using <code>ant</code>, then all you need to do is add the following to your build.xml:  <code><pre style="overflow: auto;"><br />  &lt;target name="runserver" depends="datanucleusenhance"<br />      description="Starts the development server."&gt;<br />    &lt;dev_appserver war="war"&gt;<br />      &lt;options&gt;<br />        &lt;arg value="--jvm_flag=-Drdbms.server=local"/&gt;<br />        &lt;arg value="--jvm_flag=-Drdbms.driver=com.mysql.jdbc.Driver"/&gt;<br />        &lt;arg value="--jvm_flag=-Drdbms.url=jdbc:mysql://127.0.0.1:3306/wordpress0?user=root"/&gt;<br />      &lt;/options&gt;<br />    &lt;/dev_appserver&gt;<br />  &lt;/target&gt;<br /></pre></code></p> <p>For the development server only, any dummy JDBC url string that begins with <code>jdbc:google:rdbms//</code> gets redirected to the local MySQL instance.  But you still need to pass in the correct credentials to the mysql functions for both the development server and GAE: </p> <code><pre style="overflow: auto;"><br />  // $user and $pass must be valid<br />  // Google Cloud SQL default user is <code>root</code> with an empty password<br />  $db = mysql_connect('jdbc:google:rdbms://foo:bar', $user, $pass);<br /></pre></code> </li></ol>  <p><h4><u>B. Setting up Google Cloud SQL</u></h4></p>  <p>If we wish to deploy to GAE, we also need to enable Google Cloud SQL and billing. </p> <ol><li><p><a href="https://developers.google.com/cloud-sql/docs/before_you_begin">Activate Google Cloud SQL</a> and turn on billing.  Create a new Cloud SQL instance. </p> <p>Google Cloud SQL is priced at two levels: a per-month or a per-use plan.  There is currently no free trial quota. </p></li> <li><a href="https://developers.google.com/cloud-sql/docs/access_control">Grant your application access</a> to the newly-created Cloud SQL instance. </li> <li>Create a <code>quercusproject/war/mysql.php</code> file with the following:  <code><pre style="overflow: auto;"><br />&lt;pre&gt;<br />&lt;?php<br /><br />  <b>$jdbc_url = 'jdbc:google:rdbms//project_name:instance_name';</b><br />  $db = mysql_connect($jdbc_url);<br /><br />  $result = mysql_query('SHOW DATABASES', $db);<br /><br />  while (($row = mysql_fetch_assoc($result))) {<br />    var_dump($row);<br />  }<br /><br />?&gt;<br /></pre></code> <p>Note: remember to update <code>$jdbc_url</code> with the actual JDBC url for your MySQL instance. </p> <p>Note: Google Cloud SQL's <code>root</code> user has an empty default password. </p></li> <li>Deploy the application to GAE and browse to mysql.php.  You should see a list of database names from your MySQL instance. </li></ol> <p><h3><u>VI. Putting it all together – Running Wordpress on GAE</u></h3></p> <p>We now have all the pieces to install a stock Wordpress onto GAE. </p> <ol><li>Download Wordpress at <a href="http://wordpress.org/download/">http://wordpress.org/download/</a>. </li> <li>Uncompress the archive into your quercusproject/war directory. </li> <li>Make sure the bucket name is set in web.xml. </li> <li>Create a new MySQL database for Wordpress: <code><pre><br />    CREATE DATABASE wordpress0;<br /></pre></code></li> <li>Deploy your application to GAE. </li> <li><p>Browse to <code>wordpress/</code> and follow the prompts to install Wordpress.  The default database user should be <code>root</code> with an empty password.  Your Google Cloud SQL instance's base JDBC URL should go into the “Database Host” field.  Wordpress will automatically create a custom config file and populate the database with initial data. </p> <div style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-8xa1DjzkB7E/UMB8b8WufZI/AAAAAAAAAB8/Y2R0AqYGAlA/s1600/quercus_wordpress_install.png" style="margin-left:1em; margin-right:1em"><img border="0" height="270" width="400" src="http://4.bp.blogspot.com/-8xa1DjzkB7E/UMB8b8WufZI/AAAAAAAAAB8/Y2R0AqYGAlA/s400/quercus_wordpress_install.png" /></a></div> </li>  <li><p>Wordpress will then prompt you to configure an admin account: </p> <div style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-gQ2MQ9gqsVw/UMB9IqtUzTI/AAAAAAAAACI/C5t6Fftwwlo/s1600/quercus_wordpress_install_done.png" style="margin-left:1em; margin-right:1em"><img border="0" height="262" width="400" src="http://1.bp.blogspot.com/-gQ2MQ9gqsVw/UMB9IqtUzTI/AAAAAAAAACI/C5t6Fftwwlo/s400/quercus_wordpress_install_done.png" /></a></div> </li> <li><p>And then you're done! </p> <div style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-SvLCi4zCkNE/UMB-V7hSR_I/AAAAAAAAACg/yAn-j6ecGyA/s1600/quercus_wordpress_home2.png" style="margin-left:1em; margin-right:1em"><img border="0" height="286" width="400" src="http://4.bp.blogspot.com/-SvLCi4zCkNE/UMB-V7hSR_I/AAAAAAAAACg/yAn-j6ecGyA/s400/quercus_wordpress_home2.png" /></a></div>   </li> </ol> <p>Congrats!  Your blog is installed and lives in the <em>Cloud</em>. </p> <p>Here is a sample Wordpress site running on GAE: <a href="http://wordpress-on-quercus-2.appspot.com/">http://wordpress-on-quercus-2.appspot.com/</a></p>  <p><h3><u>VII. Source Code</u></h3></p> <p>The source code for the examples are available on <a href="https://github.com/diablonhn/quercus_on_gae_2">GitHub</a>. </p> <p><em>Author: Nam Nguyen is a Software Engineer at <a href="http://www.caucho.com/">Caucho Technology</a> in San Francisco/San Diego, CA.  He is currently the lead for the Quercus project.</em></p> <p><em>Meta: this post is part of the <a href="http://javaadvent.com/">Java Advent Calendar</a> and is licensed under the <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons 3.0 Attribution</a> license. If you like it, please spread the word by sharing, tweeting, FB, G+ and so on! Want to write for the blog? We are looking for contributors to fill all 24 slot and would love to have your contribution! <a href="mailto:dify.ltd@gmail.com">Contact Attila Balazs</a> to contribute!</em></p>